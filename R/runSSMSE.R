#' run an MSE using SS OMs
#' 
#' High level function to run a management strategy evaluation using Stock
#' Synthesis as the Operating model(s)
run_SSMSE <- function() {
  
}


#' Run an MSE scenario using SS OM
#' 
#' High level function to run 1 scenario (but potentially many iterations) for 
#' a management strategy evaluation using Stock Synthesis as the Operating Model
run_SSMSE_scen <- function() {
  
}

#' Run an iteration of an MSE using SS OM
#' 
#' High level function to run 1 iteration of a scenario for a management 
#' strategy evaluation using Stock Synthesis as the Operating model
#' 
#' @author Kathryn Doering
#' 
#' @param OM_name Name of a valid Stock Synthesis stock assessment model from 
#'   which to create the OM. Currently, only allows models in the package, so 
#'   valid inputs are: \code{"cod"}.
#' @param use_SS_boot Should a bootstrapped data set generated by SS be used? 
#'   Defaults to TRUE.
#' @param EM_name Name of a valid Stock Synthesis stock assessment model to use
#'   as an EM. If value is NULL, no EM will be run. Currently only allows models
#'   in the package, so valid inputs are: \code{"cod"} or \code{NULL}.
#' @param MS The management strategy to use for this iteration. Options
#'   currently are \code{"last_yr_catch"} which uses the previous year's catch.
#'   (Note that in the future there should be an option to use the management 
#'   strategy from SS) 
#' @param out_dir The directory to which to write output. IF NULL, will default
#'   to the working directory.
#' @param nyrs Number of years beyond the years included in the OM to run the
#'   MSE. A single integer value.
#' @param nyrs_assess The number of years between assessments. E.g., if an
#'   assessment is conducted every 3 years, put 3 here. A single integer value.
#'   (NOTE: we could make this more flexible by instead reading in a vector of
#'   assessment years, so users could specify irregular numbers of yrs between
#'   assessments.)
#' @param impl_error Future parameter to specify implementation error.
#' @param niter The iteration number
#' @param verbose Want verbose output? Defaults to FALSE.
#' 
#' 
run_SSMSE_iter <- function(OM_name     = "cod", 
                         use_SS_boot = TRUE, 
                         EM_name     = NULL,
                         MS          = "last_yr_catch",
                         out_dir     = NULL,
                         nyrs        = 100, 
                         nyrs_assess = 3,
                         impl_error  = NULL,
                         niter = 1, 
                         verbose = FALSE) {
  # input checks ----
  pkg_mods <- list.files(system.file("extdata", "models", package = "SSMSE"))
  if(!OM_name %in% pkg_mods) {
    stop("Currently, OM_name can only be one of the following: ", pkg_mods)
  }
  # get and create directories ----
  # get the directory to the models
  pkg_dirs <- list.dirs(system.file("extdata", "models", package = "SSMSE"))
  SA_dir <- pkg_dirs[grep(OM_name, pkg_dirs, fixed = TRUE)]
  if(is.null(out_dir)) {
    out_dir <- file.path(getwd(), as.character(niter))
  } else {
    out_dir <- file.path(normalizePath(out_dir), as.character(niter))  
  } 
  dir.create(out_dir)
  # create the OM directory
  OM_dir <- file.path(out_dir, paste0(OM_name, "_OM"))
  dir.create(OM_dir)
  
  # MSE first iteration ----
  # turn the EM into an OM
  create_OM(OM_dir = OM_dir, SA_dir, overwrite = TRUE, verbose = verbose)
  # Complete the OM run so it can be use for expect values or bootstrap
  OM_data <- run_init_OM(OM_dir = OM_dir, boot = use_SS_boot, nboot = 1, 
                             verbose = verbose)
  if(use_SS_boot == FALSE) {
    stop("Currently, only sampling can be done using the bootstrapping ", 
         "capabilities within SS")
    # TODO: add sampling functionsthen run a future sampling function that would
    # make it into a dataset.
  }
  
  if(!is.null(EM_name)) {
    stop("Option to run EM is not yet possible")
    #run_EM()
  } else {
    if(MS == "last_yr_catch") {
      # get last year catch
      new_catch <- rep(OM_data$catch$catch[nrow(OM_data$catch)], 
                       length.out = nyrs_assess)
      
    } else {
      stop("The only MS (management strategy) currently implemented is ",
      "last_yr_catch")
    }
  }
  return(new_catch) # get rid of this in the future
  
  # TODO next steps: get feedback from management strategy to OM and loop.
  # # get a vector of the assessment years. could make this into a separate 
  # # function if it ends up getting too long.
  # styr_MSE <- get_OM_lyr()
  # assess_yrs <- seq(styr_MSE, styr_MSE + nyrs, nyrs_assess)
  # for (yr in assess_yrs) {
  # future_catch <- get_catch(MS = MS)
  #add_catch_to_OM() # write a function to add the catch into the OM
  # rerun OM, get samples, etc.
  
    
  # 
  
  
  # feedback new catch into the OM
  # keep cycling through for a user specified amount of time.
}